@page "/ConfirmarRegistro"

@using AspecSLE.Services

@inject NavigationManager Nav
@inject AuthService Auth

<PageTitle>Aspec Licita - Confirmação de Email</PageTitle>

<div class="min-h-[calc(100vh-96px)] flex items-center justify-center px-4 py-8 md:py-12">
    <div class="w-full max-w-md">
        <div class="border border-border-soft shadow-sm bg-header/95 backdrop-blur rounded-xl">
            <!-- Cabeçalho -->
            <div class="px-5 pt-4 pb-3 text-center">
                <h1 class="text-lg font-semibold tracking-tight text-slate-900">
                    Confirmação de Email
                </h1>
            </div>

            <div class="px-5 pb-4">
                @if (IsProcessing)
                {
                    <!-- Estado de Carregamento -->
                    <div class="flex flex-col items-center justify-center py-8 space-y-4">
                        <svg class="animate-spin h-12 w-12 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none"
                             viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                        </svg>
                        <p class="text-sm text-slate-600">
                            Confirmando seu email, aguarde...
                        </p>
                    </div>
                }
                else if (IsSuccess)
                {
                    <!-- Estado de Sucesso -->
                    <div class="flex flex-col items-center justify-center py-8 space-y-4">
                        <div class="w-16 h-16 rounded-full bg-green-100 flex items-center justify-center">
                            <svg class="w-8 h-8 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                                 viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M5 13l4 4L19 7"/>
                            </svg>
                        </div>
                        <div class="text-center space-y-2">
                            <h2 class="text-base font-semibold text-slate-900">
                                Email Confirmado!
                            </h2>
                            <p class="text-sm text-slate-600">
                                @Message
                            </p>
                        </div>
                    </div>

                    <div class="pt-4 border-t border-border-soft">
                        <button type="button"
                                @onclick="GoToLogin"
                                class="h-9 w-full rounded-full bg-primary text-white text-sm font-medium hover:bg-primary-strong">
                            Ir para Login
                        </button>
                    </div>
                }
                else if (HasError)
                {
                    <!-- Estado de Erro -->
                    <div class="flex flex-col items-center justify-center py-8 space-y-4">
                        <div class="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center">
                            <svg class="w-8 h-8 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                                 viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </div>
                        <div class="text-center space-y-2">
                            <h2 class="text-base font-semibold text-slate-900">
                                Erro na Confirmação
                            </h2>
                            <p class="text-sm text-slate-600">
                                @Message
                            </p>
                        </div>
                    </div>

                    <div class="pt-4 border-t border-border-soft space-y-2">
                        <button type="button"
                                @onclick="Retry"
                                class="h-9 w-full rounded-md bg-primary text-white text-sm font-medium hover:bg-primary-strong">
                            Tentar Novamente
                        </button>
                        <button type="button"
                                @onclick="GoToHome"
                                class="h-9 w-full rounded-md border border-border-soft text-slate-700 text-sm font-medium hover:bg-slate-50">
                            Voltar para Início
                        </button>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromQuery] public string? Email { get; set; }

    [SupplyParameterFromQuery] public string? Token { get; set; }

    private bool IsProcessing { get; set; } = true;
    private bool IsSuccess { get; set; }
    private bool HasError { get; set; }
    private string Message { get; set; } = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await ConfirmEmail();
    }

    private async Task ConfirmEmail()
    {
        IsProcessing = true;
        IsSuccess = false;
        HasError = false;
        Message = string.Empty;

        // Validação dos parâmetros
        if (string.IsNullOrWhiteSpace(Email) || string.IsNullOrWhiteSpace(Token))
        {
            IsProcessing = false;
            HasError = true;
            Message = "Link de confirmação inválido. Verifique se você copiou o link completo do email.";
            return;
        }

        // Chama a API
        var (ok, message) = await Auth.ConfirmEmailAsync(Email, Token);

        IsProcessing = false;

        if (ok)
        {
            IsSuccess = true;
            Message = message ?? "Email confirmado com sucesso! Você já pode fazer login.";
        }
        else
        {
            HasError = true;
            Message = message ?? "Token inválido ou expirado.";
        }
    }

    private async Task Retry()
    {
        await ConfirmEmail();
    }

    private void GoToLogin()
    {
        Nav.NavigateTo("/entrar");
    }

    private void GoToHome()
    {
        Nav.NavigateTo("/");
    }

}
